<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visor BD_MASTER - I.E. Bajo Cauca</title>

  <!-- Minimal, clean styles -->
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --muted:#6b7280; --accent:#0b5cff;
      --shadow: 0 8px 24px rgba(15,20,30,0.06);
      --radius:12px;
      --glass: rgba(255,255,255,0.6);
      font-synthesis: none;
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:var(--bg);color:#111}
    .wrap{max-width:1200px;margin:20px auto;padding:12px}
    header{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#0b5cff,#4ea8ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    h1{font-size:20px;margin:0}
    .small{font-size:13px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:320px 1fr;gap:12px}
    .card{background:var(--card);padding:12px;border-radius:var(--radius);box-shadow:var(--shadow)}
    .controls{display:flex;flex-direction:column;gap:8px}
    label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    input[type="search"], select, button{padding:8px 10px;border-radius:8px;border:1px solid #e6e9ef;background:#fff;font-size:14px}
    .row{display:flex;gap:8px;align-items:center}
    button.primary{background:var(--accent);color:#fff;border:none;padding:9px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #e6e9ef;border-radius:8px;padding:8px}
    .suggestions{position:relative}
    .suggest-list{position:absolute;left:0;right:0;z-index:60;background:#fff;border:1px solid #e6e9ef;max-height:260px;overflow:auto;border-radius:8px;margin-top:6px;box-shadow:0 10px 30px rgba(10,20,40,0.06)}
    .suggest-item{padding:8px;border-bottom:1px solid #f4f6fa}
    .suggest-item:hover{background:#fbfdff;cursor:pointer}

    /* table */
    #tablaWrapper{overflow:auto}
    table{border-collapse:collapse;width:100%;min-width:900px}
    thead th{background:#f1f4f9;padding:10px;text-align:left;border-bottom:2px solid #edf0f6;font-weight:700;position:sticky;top:0;z-index:5}
    tbody td{padding:8px;border-bottom:1px solid #f4f6fa}
    tbody tr:hover{background:#fbfdff;cursor:pointer}
    .meta{font-size:12px;color:var(--muted)}
    .kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .kpi{padding:10px;border-radius:8px;background:linear-gradient(180deg, #fff,#fbfdff);display:flex;justify-content:space-between;align-items:center}
    .kpi .title{font-size:12px;color:var(--muted)}
    .kpi .value{font-weight:700;font-size:18px}

    .bottom-bar{display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:8px}
    .small-muted{font-size:12px;color:var(--muted)}

    /* modal */
    .modal-back{position:fixed;inset:0;background:rgba(5,10,20,0.5);display:none;align-items:center;justify-content:center;z-index:90;padding:20px}
    .modal{background:#fff;border-radius:12px;max-width:1000px;width:100%;max-height:90vh;overflow:auto;padding:16px}
    .modal table{width:100%;border-collapse:collapse}
    .modal td{padding:6px;border-bottom:1px solid #f4f6fa}
    .col-chooser{display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto;padding:6px;border:1px solid #f3f5f8;border-radius:8px}

    @media (max-width:1000px){ .grid{grid-template-columns:1fr} table{min-width:720px} .suggest-list{left:0;right:auto;width:90vw} }
  </style>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">BD</div>
      <div>
        <h1>BD_MASTER — I.E. Bajo Cauca</h1>
        <div class="small">Visor público — solo consulta · Fuente: Google Sheets (CSV)</div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Controls + KPIs -->
      <aside class="card">
        <div class="controls">
          <div>
            <label class="small">Búsqueda inteligente</label>
            <div class="row suggestions">
              <input id="searchBox" type="search" placeholder="Escribe (min. 2 caracteres)..." />
              <button id="clearBtn" class="ghost">Limpiar</button>
              <div id="suggestList" class="suggest-list" style="display:none"></div>
            </div>
            <div class="meta" style="margin-top:6px">Sugerencias top 5 desde 2 caracteres.</div>
          </div>

          <div style="margin-top:10px">
            <label class="small">Filtros rápidos</label>
            <div style="display:flex;flex-direction:column;gap:8px">
              <div>
                <label class="small">Municipio</label>
                <select id="filterMunicipio"><option value="">— Todos —</option></select>
              </div>
              <div>
                <label class="small">Institución</label>
                <select id="filterInstitucion"><option value="">— Todas —</option></select>
              </div>
              <div>
                <label class="small">Conectividad</label>
                <select id="filterConectividad"><option value="">— Cualquiera —</option><option value="SI">SI</option><option value="NO">NO</option></select>
              </div>
              <div style="display:flex;gap:8px">
                <button id="applyFilters" class="primary">Aplicar</button>
                <button id="resetFilters" class="ghost">Reset</button>
              </div>
            </div>
          </div>

          <div style="margin-top:12px">
            <label class="small">Columnas visibles</label>
            <div class="col-chooser" id="colChooser"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="saveCols" class="primary">Guardar selección</button>
              <button id="resetCols" class="ghost">Reset columnas</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <label class="small">Opciones privacidad</label>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="toggleHideContacts" type="checkbox" checked />
              <label class="small">Ocultar contactos (cel, email) en tabla</label>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="meta">Controles de página</div>
            <div class="row" style="margin-top:6px">
              <label class="small">Mostrar</label>
              <select id="pageSize"><option value="10">10</option><option value="25">25</option><option value="50">50</option></select>
              <button id="reload" class="ghost">Recargar</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="small">KPIs</div>
            <div class="kpi-grid">
              <div class="kpi"><div><div class="title">Total General (suma)</div><div id="kpiTotal" class="value">—</div></div></div>
              <div class="kpi"><div><div class="title">Docentes 2024 (suma)</div><div id="kpiDoc2024" class="value">—</div></div></div>
              <div class="kpi"><div><div class="title">Sedes (visible)</div><div id="kpiSedes" class="value">—</div></div></div>
              <div class="kpi"><div><div class="title">Conectividad % (SI)</div><div id="kpiConn" class="value">—</div></div></div>
            </div>
            <div style="margin-top:10px">
              <canvas id="chartSedes" style="width:100%;height:160px"></canvas>
            </div>
          </div>

        </div>
      </aside>

      <!-- RIGHT: Table + preview -->
      <main>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small">Resultados: <span id="resultsCount">—</span></div>
              <div class="meta" id="activeFilters"></div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <label class="small">Columnas por defecto: </label>
              <div id="visibleColsList" class="meta" style="margin-left:6px"></div>
            </div>
          </div>

          <div id="tablaWrapper" style="margin-top:10px">
            <div id="loading" class="meta">Cargando datos…</div>
            <table id="dataTable" style="display:none" aria-describedby="tabla-datos"></table>

            <div class="bottom-bar">
              <div>
                <button id="btnMore" class="primary" style="display:none">Mostrar más</button>
                <span class="small-muted" id="endInfo"></span>
              </div>
              <div class="small-muted">Filas totales: <span id="totalRows">—</span></div>
            </div>
          </div>
        </div>

        <div id="preview" class="card" style="margin-top:12px;display:none"></div>
      </main>
    </div>

    <!-- Modal -->
    <div id="modalBack" class="modal-back">
      <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 id="modalTitle" style="margin:0">Detalle</h3>
          <div style="display:flex;gap:8px">
            <button id="copyRow" class="ghost">Copiar fila (CSV)</button>
            <button id="closeModal" class="ghost">Cerrar</button>
          </div>
        </div>
        <div id="modalBody" style="margin-top:10px"></div>
      </div>
    </div>

  </div>

<script>
/* =============== CONFIG =============== */
/* URL CSV pública */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRe5o92LzVVZNSuqn2eUpGf3t1nr_rf58V37ypPjGldYnxNg1B9XTrtZCvNSU-VTKdszHXD9WeqE8sk/pub?gid=1700850446&single=true&output=csv";

/* Column defaults (human-friendly names will be normalized) */
const DEFAULT_VISIBLE_KEYS = ["MUNICIPIO","INSTITUCION","SEDE","TOTAL GENERAL","2024 DOCENTES","CONECTIVIDAD","UBICACION","JORNADA"];

/* Seguridad / UX */
const HIDE_CONTACTS_BY_DEFAULT = true; // oculta columnas con email/cel en tabla por defecto
const SUGGEST_LIMIT = 5;
const DEBOUNCE_MS = 250;

/* =============== Estado =============== */
let rawRows = [];     // raw arrays from CSV
let headerRow = [];   // row index 2 (fila 3) normalized visible names
let sectionRow1 = []; // optional fila1
let sectionRow2 = []; // optional fila2
let rows = [];        // array of objects {visibleHeader: value}
let filtered = [];    // after filters/search
let displayed = 0;    // how many rows displayed
let pageSize = 10;
let indices = {municipio: -1, institucion: -1, total_general: -1, docentes_2024: -1, conectividad: -1};
let preferCols = [];  // visible columns preference

/* =============== Utilidades (normalización y seguridad) =============== */

function safeText(s){ return s === undefined || s === null ? '' : String(s); }

// fix mojibake attempt
function fixEncoding(s){
  try { return decodeURIComponent(escape(s)); } catch(e){ return s; }
}

// normalize single header cell to Visible form (no diacritics) and key
function normalizeCell(raw){
  const fixed = fixEncoding(safeText(raw)).replace(/[\u0000-\u001F]/g,'').trim();
  const noAccents = fixed.normalize('NFD').replace(/\p{Diacritic}/gu,'');
  const visible = noAccents.replace(/\s+/g,' ').replace(/\u00A0/g,' ').trim();
  const key = visible.toUpperCase().replace(/[^A-Z0-9]+/g,'_').replace(/^_|_$/g,'');
  return {visible: visible || '', key};
}

// escape text for CSV copying (simple)
function csvEscape(s){
  if(s === undefined || s === null) return '';
  const t = String(s).replace(/"/g,'""');
  if(t.includes(',') || t.includes('"') || t.includes('\n')) return `"${t}"`;
  return t;
}

// detect index by visible label (exact or includes fallback)
function findIdxByLabel(label){
  if(!label) return -1;
  const U = label.toUpperCase();
  for(let i=0;i<headerRow.length;i++){
    if(headerRow[i].visible.toUpperCase() === U) return i;
  }
  for(let i=0;i<headerRow.length;i++){
    if(headerRow[i].visible.toUpperCase().includes(U)) return i;
  }
  return -1;
}

/* =============== CSV Load & Parse =============== */

function loadCSV(){
  document.getElementById('loading').textContent = 'Cargando CSV…';
  Papa.parse(CSV_URL, { download:true, skipEmptyLines:false, complete: function(res){
    rawRows = res.data.map(r => r.map(c => c === undefined ? '' : String(c)));
    // trim trailing empty rows
    while(rawRows.length && rawRows[rawRows.length-1].every(x=>x.trim()==='')) rawRows.pop();

    if(rawRows.length < 3){
      document.getElementById('loading').textContent = 'CSV inválido: se esperaban al menos 3 filas (2 filas de secciones + 1 fila de encabezado).';
      return;
    }

    // detect section rows (fila1 = rawRows[0], fila2 = rawRows[1], headerRow = rawRows[2])
    sectionRow1 = rawRows[0].slice();
    sectionRow2 = rawRows[1].slice();
    headerRow = rawRows[2].map(cell => normalizeCell(cell));

    // build object rows from row index 3 onwards
    rows = rawRows.slice(3).map(r => {
      const obj = {};
      for(let i=0;i<headerRow.length;i++){
        const k = headerRow[i] ? headerRow[i].visible : `C${i}`;
        obj[k] = r[i] === undefined ? '' : r[i];
      }
      return obj;
    });

    // detect key indices
    indices.municipio = findIdxByLabel('MUNICIPIO');
    indices.institucion = findIdxByLabel('INSTITUCION');
    indices.total_general = findIdxByLabel('TOTAL GENERAL') !== -1 ? findIdxByLabel('TOTAL GENERAL') : findIdxByLabel('TOTAL_GENERAL');
    indices.docentes_2024 = findIdxByLabel('2024 DOCENTES') !== -1 ? findIdxByLabel('2024 DOCENTES') : findIdxByLabel('2024_DOCENTES');
    indices.conectividad = findIdxByLabel('CONECTIVIDAD');

    // build initial filtered
    filtered = rows.slice();
    // init UI now
    initUI();
  }, error: function(err){
    document.getElementById('loading').textContent = 'Error leyendo CSV: ' + (err && err.message ? err.message : JSON.stringify(err));
  }});
}

/* =============== UI Init =============== */

function initUI(){
  document.getElementById('loading').style.display = 'none';
  document.getElementById('dataTable').style.display = '';
  document.getElementById('totalRows').textContent = rows.length;
  pageSize = parseInt(document.getElementById('pageSize').value,10) || 10;

  // build column chooser
  buildColChooser();

  // fill filters using indices
  populateFilterOptions();

  // restore saved columns preference
  const saved = localStorage.getItem('bd_prefer_cols');
  if(saved){
    try{ preferCols = JSON.parse(saved); }catch(e){ preferCols = []; }
  } else {
    preferCols = DEFAULT_VISIBLE_KEYS.slice();
  }

  // ensure preferCols exist in header visible names, else fallback
  const allVisible = headerRow.map(h=>h.visible);
  preferCols = preferCols.filter(p => allVisible.includes(p));
  if(preferCols.length === 0){
    // fallback to first 8 headers
    preferCols = allVisible.slice(0,8);
  }

  document.getElementById('visibleColsList').textContent = preferCols.join(' · ');

  // event listeners
  document.getElementById('applyFilters').addEventListener('click', applyFilters);
  document.getElementById('resetFilters').addEventListener('click', resetFilters);
  document.getElementById('pageSize').addEventListener('change', function(){ pageSize = +this.value; resetTable(); });
  document.getElementById('reload').addEventListener('click', ()=> location.reload());
  document.getElementById('saveCols').addEventListener('click', saveCols);
  document.getElementById('resetCols').addEventListener('click', resetCols);
  document.getElementById('toggleHideContacts').checked = HIDE_CONTACTS_BY_DEFAULT;
  document.getElementById('toggleHideContacts').addEventListener('change', ()=> { resetTable(); });

  // search box debounce
  const sb = document.getElementById('searchBox');
  let debounceTimer = null;
  sb.addEventListener('input', (e) => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=> onSearchInput(e.target.value), DEBOUNCE_MS);
  });
  document.getElementById('clearBtn').addEventListener('click', ()=> { sb.value=''; filtered = rows.slice(); resetTable(); renderStats(); document.getElementById('suggestList').style.display='none'; });

  // modal controls
  document.getElementById('closeModal').addEventListener('click', ()=> document.getElementById('modalBack').style.display='none');
  document.getElementById('modalBack').addEventListener('click', (ev)=> { if(ev.target === document.getElementById('modalBack')) document.getElementById('modalBack').style.display='none'; });
  document.getElementById('copyRow').addEventListener('click', copyModalRowAsCSV);

  // initial render
  resetTable();
  renderStats();
}

/* =============== Column chooser UI =============== */

function buildColChooser(){
  const container = document.getElementById('colChooser');
  container.innerHTML = '';
  headerRow.forEach(h => {
    const label = document.createElement('label');
    label.style.display = 'flex';
    label.style.alignItems = 'center';
    label.style.gap = '8px';
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.value = h.visible;
    // default select if in default list
    chk.checked = DEFAULT_VISIBLE_KEYS.includes(h.visible);
    label.appendChild(chk);
    const span = document.createElement('span');
    span.textContent = h.visible || '(sin nombre)';
    span.style.fontSize = '13px';
    label.appendChild(span);
    container.appendChild(label);
  });
}

function saveCols(){
  const checks = document.querySelectorAll('#colChooser input[type=checkbox]');
  preferCols = [];
  checks.forEach(c => { if(c.checked) preferCols.push(c.value); });
  if(preferCols.length === 0){
    alert('Selecciona al menos una columna');
    return;
  }
  localStorage.setItem('bd_prefer_cols', JSON.stringify(preferCols));
  document.getElementById('visibleColsList').textContent = preferCols.join(' · ');
  resetTable();
}

function resetCols(){
  localStorage.removeItem('bd_prefer_cols');
  preferCols = DEFAULT_VISIBLE_KEYS.slice();
  document.querySelectorAll('#colChooser input[type=checkbox]').forEach(c => {
    c.checked = preferCols.includes(c.value);
  });
  document.getElementById('visibleColsList').textContent = preferCols.join(' · ');
  resetTable();
}

/* =============== Filters population and apply =============== */

function populateFilterOptions(){
  const setMun = new Set(); const setInst = new Set();
  rows.forEach(r => {
    const mun = safeText(r[headerRow[indices.municipio]?.visible]);
    const inst = safeText(r[headerRow[indices.institucion]?.visible]);
    if(mun.trim()) setMun.add(mun.trim());
    if(inst.trim()) setInst.add(inst.trim());
  });
  const selMun = document.getElementById('filterMunicipio');
  Array.from(setMun).sort((a,b)=>a.localeCompare(b)).forEach(v => {
    const opt = document.createElement('option'); opt.value = v; opt.textContent = v; selMun.appendChild(opt);
  });
  const selInst = document.getElementById('filterInstitucion');
  Array.from(setInst).sort((a,b)=>a.localeCompare(b)).forEach(v => {
    const opt = document.createElement('option'); opt.value = v; opt.textContent = v; selInst.appendChild(opt);
  });
}

function applyFilters(){
  const m = document.getElementById('filterMunicipio').value.trim();
  const i = document.getElementById('filterInstitucion').value.trim();
  const c = document.getElementById('filterConectividad').value.trim();
  filtered = rows.filter(r => {
    let ok = true;
    if(m) {
      const val = safeText(r[headerRow[indices.municipio]?.visible]).trim();
      ok = ok && val === m;
    }
    if(i){
      const val = safeText(r[headerRow[indices.institucion]?.visible]).trim();
      ok = ok && val === i;
    }
    if(c){
      const val = safeText(r[headerRow[indices.conectividad]?.visible]).toUpperCase();
      ok = ok && ((c === 'SI' && val.includes('SI')) || (c === 'NO' && !val.includes('SI')));
    }
    return ok;
  });
  document.getElementById('activeFilters').textContent = [m ? `Municipio: ${m}` : '', i? `Institución: ${i}` : '', c? `Conectividad: ${c}` : ''].filter(x=>x).join(' · ');
  resetTable();
  renderStats();
}

function resetFilters(){
  document.getElementById('filterMunicipio').value='';
  document.getElementById('filterInstitucion').value='';
  document.getElementById('filterConectividad').value='';
  document.getElementById('activeFilters').textContent = '';
  filtered = rows.slice();
  resetTable();
  renderStats();
}

/* =============== Search predictivo =============== */

function onSearchInput(q){
  q = safeText(q).trim();
  if(q.length < 2){
    document.getElementById('suggestList').style.display = 'none';
    return;
  }
  const matches = getTopMatches(q, SUGGEST_LIMIT);
  renderSuggestList(matches);
}

function getTopMatches(q, limit){
  const Q = q.toLowerCase();
  const scored = [];
  for(let i=0;i<rows.length;i++){
    // create a compact searchable string (municipio + institucion + sede + totalGeneral)
    const muni = safeText(rows[i][headerRow[indices.municipio]?.visible]).toLowerCase();
    const inst = safeText(rows[i][headerRow[indices.institucion]?.visible]).toLowerCase();
    const all = Object.values(rows[i]).join(' ').toLowerCase();
    let score = -1;
    if(muni.includes(Q)) score = 1;
    else if(inst.includes(Q)) score = 2;
    else if(all.includes(Q)) score = 3;
    if(score !== -1) scored.push({i,score});
  }
  scored.sort((a,b) => a.score - b.score);
  return scored.slice(0,limit).map(s => ({index: s.i, row: rows[s.i]}));
}

function renderSuggestList(list){
  const el = document.getElementById('suggestList');
  el.innerHTML = '';
  if(!list || list.length === 0){ el.style.display = 'none'; return; }
  list.forEach(it => {
    const div = document.createElement('div'); div.className='suggest-item';
    const muni = safeText(it.row[headerRow[indices.municipio]?.visible]);
    const inst = safeText(it.row[headerRow[indices.institucion]?.visible]);
    const tg = safeText(it.row[headerRow[indices.total_general]?.visible]);
    div.innerHTML = `<strong>${escapeHtml(inst || '(sin institución)')} — ${escapeHtml(muni)}</strong><div class="meta">Total General: ${escapeHtml(tg)}</div>`;
    div.addEventListener('click', ()=> {
      filtered = [ it.row ];
      document.getElementById('searchBox').value = '';
      document.getElementById('suggestList').style.display = 'none';
      document.getElementById('activeFilters').textContent = `Búsqueda: ${inst} · ${muni}`;
      resetTable();
      renderStats();
    });
    el.appendChild(div);
  });
  el.style.display = 'block';
}

/* =============== Table rendering (paginated "show more") =============== */

function resetTable(){
  displayed = 0;
  const table = document.getElementById('dataTable');
  table.innerHTML = '';
  document.getElementById('endInfo').textContent = '';
  document.getElementById('resultsCount').textContent = filtered.length;
  renderMore();
}

function renderMore(){
  const table = document.getElementById('dataTable');
  const start = displayed;
  const toShow = filtered.slice(start, start + pageSize);
  // create header if first time
  if(displayed === 0){
    const thead = document.createElement('thead');
    const tr = document.createElement('tr');
    const cols = getVisibleCols();
    cols.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      tr.appendChild(th);
    });
    thead.appendChild(tr);
    table.appendChild(thead);
    const tbody = document.createElement('tbody'); tbody.id = 'tbody'; table.appendChild(tbody);
  }
  const tbody = document.getElementById('tbody');
  const cols = getVisibleCols();
  toShow.forEach(row => {
    const tr = document.createElement('tr');
    cols.forEach(col => {
      const td = document.createElement('td');
      let val = safeText(row[col]);
      // optionally hide contacts
      if(document.getElementById('toggleHideContacts').checked && /RECTOR|DOCENTE|EMAIL|CEL|TEL/i.test(col)){
        // mask value
        if(val && val.length>0) val = '[oculto]';
      }
      td.textContent = val;
      tr.appendChild(td);
    });
    tr.addEventListener('click', ()=> openModal(row));
    tbody.appendChild(tr);
  });

  displayed += toShow.length;
  document.getElementById('resultsCount').textContent = filtered.length;
  document.getElementById('totalRows').textContent = rows.length;
  if(displayed < filtered.length){
    document.getElementById('btnMore').style.display = '';
    document.getElementById('endInfo').textContent = `Mostrando ${displayed} de ${filtered.length}`;
  } else {
    document.getElementById('btnMore').style.display = 'none';
    document.getElementById('endInfo').textContent = `Mostrando ${filtered.length} resultados.`;
  }
}

/* get visible columns based on preferCols but fallbacks handled */
function getVisibleCols(){
  const all = headerRow.map(h=>h.visible);
  // ensure preferCols exists; if empty, choose default first 10
  let cols = preferCols && preferCols.length ? preferCols.slice() : DEFAULT_VISIBLE_KEYS.slice();
  // filter out non-existing
  cols = cols.filter(c => all.includes(c));
  // ensure at least 5 cols
  if(cols.length < 5){
    cols = Array.from(new Set(cols.concat(all.slice(0,8))));
  }
  return cols;
}

/* attach show more button */
document.getElementById('btnMore').addEventListener('click', renderMore);

/* =============== Modal detail =============== */

function openModal(row){
  document.getElementById('modalTitle').textContent = row[headerRow[indices.institucion]?.visible] || 'Detalle sede';
  const body = document.getElementById('modalBody');
  body.innerHTML = '';
  const table = document.createElement('table');
  for(const key of Object.keys(row)){
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.style.width='35%'; td1.style.fontWeight='700'; td1.textContent = key;
    const td2 = document.createElement('td');
    let val = safeText(row[key]);
    // if hiding contacts, offer masked but keep full in modal but masked by default with button
    if(/EMAIL|CEL|TEL|RECTOR|DOCENTE/i.test(key) && document.getElementById('toggleHideContacts').checked){
      td2.textContent = '[oculto en tabla] ' + val;
    } else {
      td2.textContent = val;
    }
    tr.appendChild(td1); tr.appendChild(td2); table.appendChild(tr);
  }
  body.appendChild(table);
  document.getElementById('modalBack').style.display = 'flex';
  // attach copy data for this row
  document.getElementById('copyRow').dataset.csv = Object.values(row).map(csvEscape).join(',');
}

/* copy current modal row as CSV */
function copyModalRowAsCSV(){
  const csv = this.dataset.csv || '';
  navigator.clipboard.writeText(csv).then(()=> alert('Fila copiada al portapapeles (CSV)').catch(()=> alert('Copiado')) );
}

/* =============== Stats and Chart (cache results) =============== */

let statsCache = null;
function renderStats(){
  // compute aggregated KPIs for current "filtered" set (cache by reference length + first/last hash)
  const key = `${filtered.length}_${filtered[0] ? JSON.stringify(Object.values(filtered[0]).slice(0,3)).slice(0,60) : ''}`;
  if(statsCache && statsCache.key === key){
    applyStats(statsCache);
    return;
  }

  const idxTotal = headerRow[indices.total_general]?.visible;
  const idxDoc = headerRow[indices.docentes_2024]?.visible;
  const idxCon = headerRow[indices.conectividad]?.visible;
  const idxMun = headerRow[indices.municipio]?.visible;

  let sumTotal = 0, sumDoc = 0, connYes = 0;
  const countsByMun = {};
  filtered.forEach(r => {
    const tg = parseNumber(safeText(r[idxTotal]));
    if(!isNaN(tg)) sumTotal += tg;
    const d24 = parseNumber(safeText(r[idxDoc]));
    if(!isNaN(d24)) sumDoc += d24;
    const c = safeText(r[idxCon]).toUpperCase();
    if(c.includes('SI')) connYes++;
    const m = safeText(r[idxMun]) || 'SIN MUNICIPIO';
    countsByMun[m] = (countsByMun[m] || 0) + 1;
  });

  const connPct = filtered.length ? Math.round((connYes/filtered.length)*100) : 0;
  const stats = {sumTotal, sumDoc, totalSedes: filtered.length, connPct, countsByMun, key};
  statsCache = {key, ...stats};
  applyStats(statsCache);
}

function applyStats(s){
  document.getElementById('kpiTotal').textContent = Intl.NumberFormat('es-CO').format(s.sumTotal || 0);
  document.getElementById('kpiDoc2024').textContent = Intl.NumberFormat('es-CO').format(s.sumDoc || 0);
  document.getElementById('kpiSedes').textContent = Intl.NumberFormat('es-CO').format(s.totalSedes || 0);
  document.getElementById('kpiConn').textContent = `${s.connPct || 0}%`;

  // chart top 8 municipios
  const items = Object.entries(s.countsByMun).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const labels = items.map(x=>x[0]);
  const data = items.map(x=>x[1]);

  renderChart(labels, data);
}

/* Chart.js render */
let chartInstance = null;
function renderChart(labels, data){
  const ctx = document.getElementById('chartSedes').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Sedes', data }] },
    options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
}

/* =============== Helpers =============== */

function parseNumber(v){
  if(v === undefined || v === null) return NaN;
  const s = String(v).replace(/[^\d\-\.\,]/g,'').replace(/\./g,'').replace(',','.');
  const n = Number(s);
  return isNaN(n) ? NaN : n;
}

function escapeHtml(s){
  const t = safeText(s);
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* =============== Bootstrap load =============== */
(function init(){
  // set pageSize from control
  document.getElementById('pageSize').value = '10';
  pageSize = 10;
  // attach more button listener done above
  document.getElementById('btnMore').addEventListener('click', renderMore);
  // load CSV
  loadCSV();
})();

</script>
</body>
</html>
